<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>The Crush Gacha: Live Edition</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
    :root { --bg-color: #1a1a2e; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 100vh; background-color: var(--bg-color); color: #e94560; margin: 0; padding: 20px; box-sizing: border-box; transition: background-color 1s ease; }
    
    /* Responsive Containers */
    .container { background: #16213e; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-width: 500px; width: 100%; margin-bottom: 20px; text-align: center; box-sizing: border-box; }
    h1 { margin-top: 0; color: #fff; font-size: 24px; }
    h2 { color: #fff; font-size: 18px; margin-bottom: 15px; border-bottom: 2px solid #0f3460; padding-bottom: 10px;}
    
    /* Inputs & Buttons */
    input[type="email"], input[type="password"] { width: 100%; padding: 12px; margin: 10px 0; border-radius: 5px; border: 1px solid #e94560; background: #1a1a2e; color: white; box-sizing: border-box; font-size: 16px; }
    button { background-color: #e94560; color: white; border: none; padding: 12px 20px; font-size: 16px; font-weight: bold; border-radius: 8px; cursor: pointer; transition: background 0.2s; width: 100%; margin-top: 10px; box-sizing: border-box; }
    button:hover { background-color: #d13d56; }
    button:disabled { background-color: #555; cursor: not-allowed; }
    button.secondary { background-color: #0f3460; border: 1px solid #e94560; }
    
    /* Header & Tabs */
    .user-header { display: flex; justify-content: space-between; align-items: center; background: #0f3460; padding: 10px 15px; border-radius: 10px; margin-bottom: 20px; color: white; width: 100%; max-width: 500px; box-sizing: border-box;}
    .currency-badge { background: #e94560; padding: 5px 10px; border-radius: 8px; font-weight: bold; display: flex; align-items: center; gap: 5px;}
    .nav-tabs { display: flex; gap: 5px; margin-bottom: 15px; width: 100%; max-width: 500px; }
    .nav-tab { flex: 1; padding: 10px; background: #0f3460; color: white; text-align: center; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .nav-tab.active { background: #e94560; }
    #authScreen, #setupScreen, #mainApp { display: none; width: 100%; max-width: 500px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Wheel */
    .wheel-container { position: relative; width: 240px; height: 240px; margin: 20px auto; }
    .pointer { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 30px solid #fff; z-index: 10; }
    .wheel { width: 100%; height: 100%; border-radius: 50%; background: conic-gradient(#4ade80 0% 0.6%, #e94560 0.6% 100%); border: 4px solid #fff; box-sizing: border-box; transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99); }
    #resultBox { font-size: 18px; font-weight: bold; margin: 20px 0; padding: 15px; background: #0f3460; color: #fff; border-radius: 10px; min-height: 50px; display: flex; align-items: center; justify-content: center; text-align: center; }
    .golden-glow { background: #3a2a00 !important; border: 2px solid #ffd700; animation: goldenPulse 2s infinite; color: #ffd700; }
    @keyframes goldenPulse { 0% { box-shadow: 0 0 10px #ffd700; } 50% { box-shadow: 0 0 25px #ffdf00; } 100% { box-shadow: 0 0 10px #ffd700; } }

    /* Layout Elements */
    .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn-group button { flex: 1; min-width: 140px; margin-top: 0; }
    
    .quest-item { background: #0f3460; padding: 12px 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; color: #fff; font-size: 14px; margin-bottom: 8px; cursor: pointer; }
    .pts-badge { background: #4ade80; color: #000; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold; white-space: nowrap; margin-left: 10px; }
    .quest-item.completed { opacity: 0.5; text-decoration: line-through; pointer-events: none;}
    .history-log, .leaderboard-log { max-height: 300px; overflow-y: auto; text-align: left; background: #0f3460; padding: 10px; border-radius: 8px; color: white; font-size: 14px;}
    .log-entry { padding: 8px 5px; border-bottom: 1px solid #16213e; display: flex; justify-content: space-between; align-items: center; }
    .win-text { color: #4ade80; font-weight: bold; }
    .lose-text { color: #e94560; }

    /* --- MOBILE RESPONSIVENESS --- */
    @media (max-width: 480px) {
        body { padding: 10px; }
        .container { padding: 15px; margin-bottom: 15px; }
        h1 { font-size: 20px; }
        .user-header { padding: 10px; flex-wrap: wrap; gap: 10px; }
        .wheel-container { width: 200px; height: 200px; margin: 15px auto; }
        .nav-tab { padding: 8px 4px; font-size: 12px; }
        .btn-group { flex-direction: column; }
        .btn-group button { width: 100%; }
        #resultBox { font-size: 16px; padding: 10px; }
    }
</style>
</head>
<body>

<div id="authScreen" class="container" style="display: block;">
    <h1>The Crush Gacha</h1>
    <p style="color: white; font-size: 14px;">Log in or create an account to sync your despair globally.</p>
    <input type="email" id="emailInput" placeholder="Email...">
    <input type="password" id="passInput" placeholder="Password (min 6 chars)...">
    <button onclick="handleAuth('login')">Log In</button>
    <button class="secondary" onclick="handleAuth('signup')">Create Account</button>
    <div id="authMessage" style="color: #4ade80; margin-top: 10px; font-size: 14px;"></div>
</div>

<div id="setupScreen" class="container">
    <h1>Select Crush Type</h1>
    <button class="secondary" onclick="setCrushType('local')">üè´ Local (School/Nearby)</button>
    <button class="secondary" onclick="setCrushType('online')">üåê Online (Long Distance)</button>
</div>

<div id="mainApp">
    <div class="user-header">
        <div style="font-size: 12px;">User: <strong id="displayEmail" style="color: #4ade80; font-size: 14px;"></strong></div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <div class="currency-badge">üíé <span id="hopiumDisplay">0</span></div>
            <button onclick="logout()" style="width: auto; padding: 5px 10px; font-size: 12px; margin:0; background: transparent; border: 1px solid #e94560;">Logout</button>
        </div>
    </div>

    <div class="nav-tabs">
        <div class="nav-tab active" onclick="switchTab('tab-gacha')">Wish</div>
        <div class="nav-tab" onclick="switchTab('tab-quests')">Quests</div>
        <div class="nav-tab" onclick="switchTab('tab-history')">History</div>
        <div class="nav-tab" onclick="switchTab('tab-social'); loadLeaderboard();">Rank</div>
    </div>

    <div id="tab-gacha" class="tab-content active container">
        <h1>Should You Confess?</h1>
        <div style="font-size: 14px; color: #a0a0a0; margin-bottom: 10px;">Pity: <strong id="pityDisplay" style="color: white;">0</strong> / 1095</div>
        <div class="wheel-container"><div class="pointer"></div><div class="wheel" id="wheel"></div></div>
        <div id="resultBox">Waiting for a wish...</div>
        <div class="btn-group">
            <button id="spinBtn1" onclick="spin('standard')" style="background: #0f3460; border: 1px solid #e94560;">Standard Pull<br><small>160 üíé (0.6%)</small></button>
            <button id="spinBtn2" onclick="spin('event')">Delulu Banner<br><small>320 üíé (2.0%)</small></button>
        </div>
    </div>

    <div id="tab-quests" class="tab-content container">
        <h2>Daily Missions</h2>
        <div id="questList"></div>
    </div>

    <div id="tab-history" class="tab-content container">
        <h2>Pull History</h2>
        <div class="history-log" id="historyLog">No pulls yet.</div>
    </div>

    <div id="tab-social" class="tab-content container">
        <h2>Global Leaderboard</h2>
        <p style="font-size: 12px; color: #a0a0a0; margin-top: 0;">The most down-bad users in the world.</p>
        <div class="leaderboard-log" id="leaderboardLog">Loading...</div>
    </div>
</div>

<script>
    // ==========================================
    // YOUR SUPABASE CONNECTION
    // ==========================================
    const SUPABASE_URL = 'https://tkspckewwviwxjlyrdxo.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRrc3Bja2V3d3Zpd3hqbHlyZHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5MTQzMTEsImV4cCI6MjA4NzQ5MDMxMX0.YEAKicveHDbUBCRTWJg_J3zmOSIKArNKdflntgV0F_U';
    
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const MAX_PITY = 1095;
    const SOFT_PITY_START = 700;
    
    let userAuthId = null;
    let userData = { email: '', hopium: 160, pity: 0, crushType: null, questDate: '', completedQuests: {}, history: [] };
    let currentRotation = 0; 
    let audioCtx = null;

    const questsConfig = {
        local: [
            { id: 'l1', text: 'Talked to her in person', pts: 100 },
            { id: 'l2', text: 'Made her laugh', pts: 100 },
            { id: 'l3', text: 'Helped her with a task', pts: 160 },
            { id: 'l4', text: 'Hung out 1-on-1', pts: 320 }
        ],
        online: [
            { id: 'o1', text: 'Had a conversation today', pts: 100 },
            { id: 'o2', text: 'Sent/Tagged in a meme', pts: 100 },
            { id: 'o3', text: 'Played a game together', pts: 160 },
            { id: 'o4', text: 'Stayed up late talking', pts: 320 }
        ]
    };

    // --- Audio System ---
    function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    function playBeep(freq, type, duration) { if(!audioCtx) return; const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = type; osc.frequency.value = freq; osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration); osc.stop(audioCtx.currentTime + duration); }
    function playTick() { playBeep(800, 'sine', 0.1); }
    function playLose() { setTimeout(()=>playBeep(200, 'sawtooth', 0.5), 0); setTimeout(()=>playBeep(150, 'sawtooth', 0.8), 200); }
    function playWin() { [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => setTimeout(() => playBeep(freq, 'square', 0.5), i * 150)); }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.target.classList.add('active');
    }

    // --- Cloud Auth & DB Logic ---
    async function handleAuth(type) {
        const email = document.getElementById('emailInput').value.trim();
        const password = document.getElementById('passInput').value;
        const msg = document.getElementById('authMessage');
        if(!email || !password) return msg.innerText = "Please enter email and password.";
        
        msg.innerText = "Connecting to universe...";
        
        let authRes;
        if(type === 'signup') authRes = await supabaseClient.auth.signUp({ email, password });
        else authRes = await supabaseClient.auth.signInWithPassword({ email, password });

        if(authRes.error) return msg.innerText = authRes.error.message;
        
        userAuthId = authRes.data.user.id;
        userData.email = authRes.data.user.email;

        // Fetch or create profile
        let { data: profile, error } = await supabaseClient.from('gacha_data').select('*').eq('id', userAuthId).single();
        
        if (!profile) {
            // New User Setup
            profile = { id: userAuthId, email: userData.email, hopium: 160, pity: 0, crush_type: null, quest_date: new Date().toDateString(), completed_quests: {}, history: [] };
            await supabaseClient.from('gacha_data').insert([profile]);
        }

        // Map DB snake_case to JS camelCase
        userData.hopium = profile.hopium; userData.pity = profile.pity; userData.crushType = profile.crush_type;
        userData.questDate = profile.quest_date; userData.completedQuests = profile.completed_quests || {}; userData.history = profile.history || [];

        // Daily Check-in Reset
        const today = new Date().toDateString();
        if (userData.questDate !== today) {
            userData.completedQuests = {}; userData.questDate = today; userData.hopium += 160;
            await saveToCloud();
        }
        
        document.getElementById('authScreen').style.display = 'none';
        if (!userData.crushType) document.getElementById('setupScreen').style.display = 'block';
        else initApp();
    }

    async function setCrushType(type) { 
        userData.crushType = type; 
        await saveToCloud();
        initApp(); 
    }
    
    async function saveToCloud() {
        if(!userAuthId) return;
        await supabaseClient.from('gacha_data').update({
            hopium: userData.hopium, pity: userData.pity, crush_type: userData.crushType,
            quest_date: userData.questDate, completed_quests: userData.completedQuests, history: userData.history
        }).eq('id', userAuthId);
    }

    async function logout() {
        await supabaseClient.auth.signOut();
        location.reload(); 
    }

    // --- App Init ---
    function initApp() {
        document.getElementById('setupScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('displayEmail').innerText = userData.email.split('@')[0];
        updateUI(); renderQuests(); renderHistory();
    }

    function updateUI() {
        document.getElementById('hopiumDisplay').innerText = userData.hopium;
        document.getElementById('pityDisplay').innerText = userData.pity;
        
        let tension = userData.pity > SOFT_PITY_START ? (userData.pity - SOFT_PITY_START) / (MAX_PITY - SOFT_PITY_START) : 0;
        document.documentElement.style.setProperty('--bg-color', `rgb(${26 + (48 * tension)}, ${26 - (12 * tension)}, ${46 - (23 * tension)})`);
        
        let baseWinChance = 0.6; 
        if(userData.pity >= SOFT_PITY_START) baseWinChance += (tension * 99.4);
        document.getElementById('wheel').style.background = `conic-gradient(#4ade80 0% ${baseWinChance}%, #e94560 ${baseWinChance}% 100%)`;
    }

    function renderQuests() {
        const container = document.getElementById('questList'); container.innerHTML = '';
        questsConfig[userData.crushType].forEach(q => {
            const isDone = userData.completedQuests[q.id];
            container.innerHTML += `<div class="quest-item ${isDone ? 'completed' : ''}" onclick="completeQuest('${q.id}', ${q.pts})"><span>${q.text}</span> <span class="pts-badge">+${q.pts} üíé</span></div>`;
        });
    }

    async function completeQuest(id, pts) {
        if(userData.completedQuests[id]) return;
        userData.completedQuests[id] = true; userData.hopium += pts;
        updateUI(); renderQuests(); await saveToCloud();
    }

    function spin(bannerType) {
        initAudio();
        const cost = bannerType === 'event' ? 320 : 160;
        if (userData.hopium < cost) return alert("Not enough Hopium! Do your daily quests.");
        
        userData.hopium -= cost; userData.pity++;
        
        const btn1 = document.getElementById('spinBtn1'); const btn2 = document.getElementById('spinBtn2');
        const resultBox = document.getElementById('resultBox'); const wheel = document.getElementById('wheel');
        btn1.disabled = true; btn2.disabled = true; resultBox.innerText = "Listening to the universe...";
        resultBox.classList.remove('golden-glow'); updateUI();

        let winChance = bannerType === 'event' ? 0.02 : 0.006;
        if (userData.pity >= SOFT_PITY_START) winChance += (userData.pity - SOFT_PITY_START) / (MAX_PITY - SOFT_PITY_START);
        
        let isWin = userData.pity >= MAX_PITY || Math.random() < winChance;
        let landingDegree = isWin ? 360 - (Math.random() * (winChance*3.6)) : 360 - (Math.random() * 300 + 30);
        currentRotation += (360 * 5) + landingDegree - (currentRotation % 360);
        wheel.style.transform = `rotate(${currentRotation}deg)`;

        let ticks = 0; let tickInterval = setInterval(() => { playTick(); ticks++; if(ticks > 15) clearInterval(tickInterval); }, 200);

        setTimeout(async () => {
            const time = new Date().toLocaleTimeString();
            if (isWin) {
                playWin(); resultBox.innerText = "üåü YOU SHOULD CONFESS! üåü"; resultBox.classList.add('golden-glow');
                userData.history.unshift({ text: `WIN at ${userData.pity} pity!`, class: 'win-text', time: time }); userData.pity = 0; 
            } else {
                playLose(); resultBox.innerText = "You shouldn't confess.";
                userData.history.unshift({ text: `Lost at ${userData.pity} pity.`, class: 'lose-text', time: time });
            }
            if(userData.history.length > 50) userData.history.pop();
            btn1.disabled = false; btn2.disabled = false; 
            updateUI(); renderHistory(); await saveToCloud();
        }, 4000);
    }

    function renderHistory() {
        const log = document.getElementById('historyLog');
        if(userData.history.length === 0) return log.innerHTML = "No pulls yet.";
        log.innerHTML = userData.history.map(h => `<div class="log-entry"><span class="${h.class}">${h.text}</span> <small>${h.time}</small></div>`).join('');
    }

    async function loadLeaderboard() {
        const board = document.getElementById('leaderboardLog');
        board.innerHTML = "Fetching global despair data...";
        
        let { data: users, error } = await supabaseClient.from('gacha_data').select('email, pity').order('pity', { ascending: false }).limit(10);
        
        if (error) return board.innerHTML = "Failed to load leaderboard.";
        if (!users || users.length === 0) return board.innerHTML = "No users yet.";
        
        board.innerHTML = users.map((u, i) => {
            let name = u.email.split('@')[0];
            let display = name.substring(0, 3) + "***"; 
            if(u.email === userData.email) display = `<span style="color:#4ade80">${name} (You)</span>`;
            return `<div class="log-entry"><span>#${i+1} ${display}</span> <span style="color:#e94560">${u.pity} Pity</span></div>`;
        }).join('');
    }
</script>

</body>
</html>
